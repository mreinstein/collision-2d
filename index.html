<!doctype html>
<html>
<head>
    <title>collision code tests</title>
    <meta name=theme-color content=#303F9F><meta name=viewport content="width=device-width,minimum-scale=1">
    <style>
        body {
          background-color: whitesmoke;
          padding: 10px;
        }

        canvas {
          background-color: black;
        }

    </style>
</head>
<body>

  <canvas width="600" height="600"></canvas>


<script type="module">
import contact         from './contact.js'
import lineSweep       from './line-lines-intersect.js'
import lineSphereSweep from './line-sphere-sweep.js'


const canvas = document.querySelector('canvas')
const ctx = canvas.getContext('2d')


function randomInt (min, max) {
  return min + Math.round(Math.random() * (max - min)) 
}


const lines = [ ]

let startPoint, endPoint, collidePoint, collider

const sphereRadius = 20

let mode = 'SPHERE-INTERSECT'  // LINE-INTERSECT | SPHERE-INTERSECT

const c = contact()

for (let i = 0; i < 20; i++) {
  lines.push([
      [ randomInt(20, 580), randomInt(20, 580) ],
      [ randomInt(20, 580), randomInt(20, 580) ]
    ])
}

canvas.addEventListener('mousedown', function (ev) {
  if (startPoint) {
    startPoint = undefined
  } else {
    startPoint = [ ev.layerX, ev.layerY ]
    endPoint = [ ev.layerX, ev.layerY ]
  }
})


canvas.addEventListener('mousemove', function (ev) {
  if (startPoint)
      endPoint = [ ev.layerX, ev.layerY ]
})



function renderLineSweep (startPoint, endPoint) {

  if (!startPoint)
    return
    
  const delta = [
    endPoint[0] - startPoint[0],
    endPoint[1] - startPoint[1]
  ]

  if (lineSweep(lines, startPoint, delta, c))
    collidePoint = c.position
  else
    collidePoint = undefined

  if (collidePoint) {
    ctx.beginPath()
    ctx.strokeStyle = 'yellow'
    ctx.moveTo(startPoint[0], startPoint[1])
    ctx.lineTo(collidePoint[0], collidePoint[1])
    ctx.stroke()

    ctx.beginPath()
    ctx.strokeStyle = 'red'
    ctx.moveTo(collidePoint[0], collidePoint[1])
    ctx.lineTo(endPoint[0], endPoint[1])
    ctx.stroke()
  } else {
    ctx.beginPath()
    ctx.strokeStyle = 'red'
    ctx.moveTo(startPoint[0], startPoint[1])
    ctx.lineTo(endPoint[0], endPoint[1])
    ctx.stroke()
  }
}


function renderSphereIntersect (startPoint, endPoint) {
  if (!startPoint)
    return

  const delta = [
    endPoint[0] - startPoint[0],
    endPoint[1] - startPoint[1]
  ]

  if (lineSphereSweep(lines, startPoint, sphereRadius, delta, c)) {
    collidePoint = c.position
    collider = c.collider

    //console.log('sphere hit!', c)
  } else {
    collidePoint = undefined
    collider = undefined
  }

  ctx.beginPath()
    ctx.strokeStyle = 'red'
    ctx.moveTo(startPoint[0], startPoint[1])
    ctx.lineTo(endPoint[0], endPoint[1])
    ctx.stroke()


  ctx.beginPath()

  ctx.strokeStyle = 'yellow'
  ctx.ellipse(endPoint[0], endPoint[1], sphereRadius, sphereRadius, Math.PI / 4, 0, 2 * Math.PI)
  ctx.stroke()

  if (collidePoint) {
    ctx.beginPath()
    ctx.strokeStyle = 'red'
    ctx.moveTo(collidePoint[0] - 5, collidePoint[1] - 5)
    ctx.lineTo(collidePoint[0] + 5, collidePoint[1] + 5)
    
    ctx.moveTo(collidePoint[0] + 5, collidePoint[1] - 5)
    ctx.lineTo(collidePoint[0] - 5, collidePoint[1] + 5)
    ctx.stroke()

    ctx.beginPath()
    ctx.strokeStyle = 'green'

    ctx.moveTo(collider[0][0], collider[0][1])
    ctx.lineTo(collider[1][0], collider[1][1])
    ctx.stroke()
  }

}


function update () {

  ctx.clearRect(0,0, 600, 600)

  ctx.strokeStyle = 'white'
  ctx.strokeWidth = 1 / devicePixelRatio

  ctx.beginPath()

  for (const line of lines) {
    ctx.moveTo(line[0][0], line[0][1])
    ctx.lineTo(line[1][0], line[1][1])
  }

  ctx.stroke()

  if (mode === 'LINE-INTERSECT')
    renderLineSweep (startPoint, endPoint) 
  else if (mode === 'SPHERE-INTERSECT')
    renderSphereIntersect(startPoint, endPoint)

  requestAnimationFrame(update)
}


requestAnimationFrame(update)

</script>
</body>
</html>
